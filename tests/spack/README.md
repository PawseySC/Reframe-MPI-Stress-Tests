# Spack tests

This directory contains one test file, `spack_checks.py`. This file contains four separate tests, described in more detail below. There is a corresponding .yaml configuration file which defines system-level parameters and environment variables needed for the tests. Additionally, there is a file `spack_helper_methods.py` which defines functions used by the tests in processing the spack files and module names.

The `src` directory holds a tarball which contains a reduced software stack directory/file hierarchy with only a small number of packages (4). This is in the form of our software stack hierarchy on Setonix. Since other systems have different directory layouts, module naming conventions, software organisation, etc. the `module_load_check` and `baseline_sanity_check` tests will not work with default settings. They require loading of module files and running packages and therefore are specific to the system they are being run on. The tests as presented are in a format which works on Setonix, with our system and organisation of the software stack. Thus, it serves in large part as an example, which if users want, can be altered to suit their system. More details are in the README in the `src` directory.


## `spack_checks.py`

### `concretise_check`

This test checks the concretisation stage of `spack` by checking that for every abstract spec defined in a `spack.yaml` file, corresponding concretised spec(s) are defined in the `spack.lock` file. The test passes if every abstract spec is accounted for and fails if there is one or more missing concretised specs. This test is run once for every spack build environment

### `module_existence_check`

This test checks that for every package for whcih a module file is to be generated by `spack` that the module exists, as do all of the module files for its dependencies. This test is run once for every package which generates a module file.

### `module_load_check`

This test checks that for every package for which a module file is to be generated by `spack` that the module is able to be loaded without errors, failures, or warnings. The test also checks that every explicit load dependency (lines in the module file starting with `LOAD`) is loaded in the environment alongside the primary module. This test is run once for every package which generates a module file. There is a test dependency chain with this test and `module_existence_check`. For each package, this test only runs if `module_existence_check` passes for that package. If, however, the first test fails, this test will automatically fail as well.

### `baseline_sanity_check`

This test runs the most basic sanity check for each package. If the package is software the test executes a basic check of the binary via a command like `--help` or `--version`. If the test is a library, library dependencies are checked via the `ldd` command to check that all are present. This test is run once for every package and it forms a test dependency chain with the two previous tests. For each package this test only runs if both `module_existence_check` and `module_load_check` for the package have both passed.
